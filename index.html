<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="no-referrer" />
  <title>Maritime Explorer: Nature & Finn Edition</title>

  <!-- Tailwind + Chart.js + Leaflet + Lucide -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .tab-active { border-bottom: 3px solid #db2777; color: #be185d; font-weight: 700; background-color: rgba(219, 39, 119, 0.05); }
    .tab-inactive { color: #64748b; font-weight: 500; }
    .tab-inactive:hover { color: #334155; background-color: #f1f5f9; }
    #map { width: 100%; height: 400px; border-radius: 0.75rem; z-index: 1; }
    .timeline-line { position: absolute; left: 24px; top: 20px; bottom: 0; width: 2px; background-color: #e2e8f0; z-index: 0; }
    /* Hero */
    .hero-bg { background-image: linear-gradient(rgba(190, 24, 93, 0.85), rgba(88, 28, 135, 0.8)), url('https://images.unsplash.com/photo-1548199973-03cce0bbc87b?q=80&w=1920&auto=format&fit=crop'); background-size: cover; background-position: center 40%; }

    /* Login overlay */
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; }

    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
    .animate-pulse-red { animation: pulse-red 2s infinite; }

    details > summary { list-style: none; cursor: pointer; }
    details > summary::-webkit-details-marker { display: none; }
    details[open] summary ~ * { animation: slideDown 0.25s ease-in-out; }
    @keyframes slideDown { 0% { opacity: 0; transform: translateY(-8px); } 100% { opacity: 1; transform: translateY(0); } }

    /* Toast */
    #toast { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); z-index: 10000; }

    /* Small helpers */
    .kbd { border: 1px solid #cbd5e1; border-bottom-width: 2px; padding: 1px 6px; border-radius: 6px; font-size: 12px; background: #fff; }
  </style>
</head>
<body class="text-slate-800">

  <!-- PASSWORD OVERLAY (NOTE: GitHub Pages cannot be truly private; this is just a visual lock) -->
  <div id="login-overlay" role="dialog" aria-modal="true" aria-label="Unlock itinerary">
    <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border-4 border-pink-500/20">
      <div class="text-5xl mb-6">ğŸ”’</div>
      <h2 class="text-2xl font-bold text-slate-800 mb-2">Maritime Planner</h2>
      <p class="text-sm text-slate-500 mb-6">Enter password to view itinerary.</p>

      <input
        type="password"
        id="password-input"
        placeholder="Enter password"
        class="w-full p-3 border border-slate-300 rounded-lg mb-4 focus:ring-2 focus:ring-pink-500 outline-none transition text-center text-lg"
        autocomplete="current-password"
      />

      <!-- Keep inline handler for simplicity; JS also exports to window for compatibility. -->
      <button
        onclick="checkPassword()"
        class="w-full bg-pink-700 text-white font-bold py-3 rounded-lg hover:bg-pink-800 transition shadow-lg transform active:scale-95"
      >
        Unlock Plan
      </button>

      <p id="error-msg" class="text-red-500 text-xs mt-3 hidden font-bold">Incorrect password.</p>
      <p class="text-[11px] text-slate-400 mt-4">Tip: you can also press <span class="kbd">Enter</span>.</p>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="hidden">
    <div class="bg-slate-900 text-white text-sm px-4 py-3 rounded-xl shadow-xl border border-white/10 flex items-center gap-2">
      <span id="toast-icon">âœ…</span>
      <span id="toast-text">Copied!</span>
    </div>
  </div>

  <!-- MAIN APP CONTAINER -->
  <div id="app-container" class="hidden max-w-7xl mx-auto min-h-screen flex flex-col bg-slate-50 shadow-2xl my-0 md:my-8 rounded-2xl overflow-hidden">

    <!-- Hero Header -->
    <header class="hero-bg text-white p-8 md:p-12 shadow-lg">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
        <div>
          <h1 class="text-4xl md:text-5xl font-bold tracking-tight mb-2">The Nature Loop</h1>
          <p class="text-pink-100 text-xl font-light">Ottawa â†’ PEI Wildlife â†’ Fundy â†’ Ottawa</p>
          <div class="mt-4 flex flex-wrap gap-2">
            <span class="inline-flex items-center gap-2 bg-white/10 border border-white/15 px-3 py-1.5 rounded-full text-sm">
              <span class="text-lg">ğŸ“…</span>
              <span id="trip-dates" class="font-semibold">Aug 15â€“22</span>
            </span>
            <button
              id="btn-download-ics"
              class="inline-flex items-center gap-2 bg-white/10 hover:bg-white/15 border border-white/15 px-3 py-1.5 rounded-full text-sm font-semibold transition"
              title="Download calendar file"
            >
              <span class="text-lg">ğŸ—“ï¸</span>
              Download .ics
            </button>
            <button
              id="btn-share"
              class="inline-flex items-center gap-2 bg-white/10 hover:bg-white/15 border border-white/15 px-3 py-1.5 rounded-full text-sm font-semibold transition"
              title="Copy share link"
            >
              <span class="text-lg">ğŸ”—</span>
              Copy link
            </button>
          </div>
        </div>

        <div class="bg-white/10 backdrop-blur-md px-6 py-4 rounded-xl border border-white/20">
          <span class="block text-xs text-pink-200 uppercase tracking-widest font-bold mb-2">Trip Profile</span>
          <div class="grid grid-cols-2 gap-x-6 gap-y-2">
            <div class="flex items-center"><span class="text-2xl mr-2">ğŸ¶</span><span class="font-bold">With Finn</span></div>
            <div class="flex items-center"><span class="text-2xl mr-2">ğŸ¦…</span><span class="font-bold">Nature Focus</span></div>
            <div class="flex items-center"><span class="text-2xl mr-2">ğŸš—</span><span class="font-bold">Road Trip</span></div>
            <div class="flex items-center"><span class="text-2xl mr-2">ğŸ§­</span><span class="font-bold">Non-touristy</span></div>
          </div>
        </div>
      </div>

      <!-- Quick Stats Row -->
      <div class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="bg-white/10 border border-white/15 rounded-xl p-4">
          <div class="text-xs text-pink-100/80 uppercase font-bold tracking-widest">Distance</div>
          <div id="stat-distance" class="text-2xl font-extrabold">~2,850 km</div>
          <div class="text-xs text-pink-100/80">loop estimate</div>
        </div>
        <div class="bg-white/10 border border-white/15 rounded-xl p-4">
          <div class="text-xs text-pink-100/80 uppercase font-bold tracking-widest">Drive Time</div>
          <div id="stat-drive" class="text-2xl font-extrabold">~31 h</div>
          <div class="text-xs text-pink-100/80">total</div>
        </div>
        <div class="bg-white/10 border border-white/15 rounded-xl p-4">
          <div class="text-xs text-pink-100/80 uppercase font-bold tracking-widest">Night Stops</div>
          <div id="stat-nights" class="text-2xl font-extrabold">7</div>
          <div class="text-xs text-pink-100/80">sleep locations</div>
        </div>
        <div class="bg-white/10 border border-white/15 rounded-xl p-4">
          <div class="text-xs text-pink-100/80 uppercase font-bold tracking-widest">Key Booking</div>
          <div class="text-2xl font-extrabold">Feb 9</div>
          <div class="text-xs text-pink-100/80">Parks Canada</div>
        </div>
      </div>

    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
      <div class="flex overflow-x-auto px-4 md:px-8 items-center">
        <button onclick="switchTab('route')" id="tab-route" class="tab-active py-5 px-6 whitespace-nowrap transition-all flex items-center"><span class="mr-2">ğŸ—ºï¸</span> Daily Itinerary</button>
        <button onclick="switchTab('budget')" id="tab-budget" class="tab-inactive py-5 px-6 whitespace-nowrap transition-all flex items-center"><span class="mr-2">ğŸ’°</span> Budget</button>
        <button onclick="switchTab('attractions')" id="tab-attractions" class="tab-inactive py-5 px-6 whitespace-nowrap transition-all flex items-center"><span class="mr-2">ğŸ¦…</span> Wildlife Spots</button>
        <button onclick="switchTab('logistics')" id="tab-logistics" class="tab-inactive py-5 px-6 whitespace-nowrap transition-all flex items-center"><span class="mr-2">ğŸ“‹</span> Logistics <span class="ml-2 bg-red-500 text-white text-[10px] px-1 rounded animate-pulse">!</span></button>

        <div class="ml-auto flex items-center gap-2 pr-2">
          <button id="btn-print" class="hidden md:inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
            ğŸ–¨ï¸ Print
          </button>
          <button id="btn-lock" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold" title="Lock page">
            ğŸ”’ Lock
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 md:p-8">

      <!-- TAB: ROUTE -->
      <section id="content-route" class="space-y-8">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <div id="map"></div>
            <div class="mt-4 flex flex-wrap gap-2 text-sm">
              <button id="btn-fit" class="px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 font-semibold">ğŸ§­ Fit route</button>
              <button id="btn-toggle-markers" class="px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 font-semibold">ğŸ“ Toggle markers</button>
              <button id="btn-toggle-lines" class="px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 font-semibold">ã€°ï¸ Toggle lines</button>
              <span class="ml-auto text-slate-500">Tip: click markers for stops.</span>
            </div>
          </div>

          <aside class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Trip Controls</h2>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Search itinerary</label>
                <input id="itinerary-search" type="text" placeholder="Try: whale, fox, Fundy, RiviÃ¨reâ€¦" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none transition" />
                <p class="text-xs text-slate-400 mt-1">Filters the day cards below.</p>
              </div>

              <div class="grid grid-cols-2 gap-2">
                <button id="btn-expand-all" class="px-3 py-2 rounded-lg bg-slate-800 text-white font-bold hover:bg-slate-900">Expand all</button>
                <button id="btn-collapse-all" class="px-3 py-2 rounded-lg bg-white border border-slate-200 font-bold hover:bg-slate-50">Collapse</button>
              </div>

              <div class="border-t border-slate-100 pt-4">
                <div class="text-xs text-slate-500 uppercase font-bold tracking-widest">Legend</div>
                <div class="mt-2 space-y-2 text-sm">
                  <div class="flex items-center gap-2"><span class="text-green-600 font-bold">ğŸ¦…</span><span>Birding / wildlife</span></div>
                  <div class="flex items-center gap-2"><span class="text-indigo-600 font-bold">â­</span><span>Finn-friendly highlight</span></div>
                  <div class="flex items-center gap-2"><span class="text-pink-600 font-bold">ğŸ“</span><span>Map stop / pin</span></div>
                </div>
              </div>
            </div>
          </aside>
        </div>

        <!-- Day by Day Timeline -->
        <div class="relative space-y-4" id="itinerary-list">

          <!-- Day 1 -->
          <details class="day-card group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" data-day="1" data-tags="ottawa riviere-du-loup grand falls trapper cabin barred owl parc de la pointe">
            <summary class="flex items-center p-4 bg-slate-50 cursor-pointer select-none">
              <div class="bg-pink-600 text-white font-bold w-12 h-12 rounded-lg flex items-center justify-center text-xl shadow-md z-10">1</div>
              <div class="ml-4 flex-grow">
                <h3 class="font-bold text-slate-800 text-lg">Sat, Aug 15: The Great Escape</h3>
                <p class="text-sm text-slate-500">Ottawa â†’ Trapper's Cabin (715 km)</p>
              </div>
              <div class="text-slate-400 transform group-open:rotate-180 transition-transform">â–¼</div>
            </summary>
            <div class="p-6 border-t border-slate-100">
              <ul class="space-y-4 text-sm text-slate-700">
                <li class="flex"><span class="font-bold w-20 text-slate-400">07:00</span><span>Depart Ottawa. Get on the 417 East.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">12:30</span><span><strong>Lunch in RiviÃ¨re-du-Loup:</strong> Stop at <em>Parc de la Pointe</em>. <br><span class="text-green-600 font-bold text-xs">ğŸ¦… Birding:</span> Look for Eiders and Gulls near the marina.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">16:00</span><span><strong>Grand Falls, NB:</strong> Grocery Run (IGA). Last chance for supplies!</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">17:30</span><span><strong>Arrive Upper Kintore:</strong> Check into Trapper's Cabin (Booked). <br><span class="text-green-600 font-bold text-xs">ğŸ¦‰ Nature:</span> Listen for Barred Owls at dusk. Off-grid night.</span></li>
              </ul>
              <div class="mt-5 flex flex-wrap gap-2">
                <button class="btn-map px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-focus="trapper">ğŸ“ Focus stop</button>
                <button class="btn-copy px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-copy="Sat Aug 15 â€” Ottawa â†’ Trapper's Cabin. Stops: RiviÃ¨re-du-Loup (Parc de la Pointe), Grand Falls grocery, arrive Upper Kintore." >ğŸ“‹ Copy summary</button>
              </div>
            </div>
          </details>

          <!-- Day 2 -->
          <details class="day-card group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" data-day="2" data-tags="sackville waterfowl park boardwalk confederation bridge stanhope campground fox dunes">
            <summary class="flex items-center p-4 bg-slate-50 cursor-pointer select-none">
              <div class="bg-amber-500 text-white font-bold w-12 h-12 rounded-lg flex items-center justify-center text-xl shadow-md z-10">2</div>
              <div class="ml-4 flex-grow">
                <h3 class="font-bold text-slate-800 text-lg">Sun, Aug 16: Marshes & Bridge</h3>
                <p class="text-sm text-slate-500">NB â†’ Stanhope, PEI (400 km)</p>
              </div>
              <div class="text-slate-400 transform group-open:rotate-180 transition-transform">â–¼</div>
            </summary>
            <div class="p-6 border-t border-slate-100">
              <ul class="space-y-4 text-sm text-slate-700">
                <li class="flex"><span class="font-bold w-20 text-slate-400">09:00</span><span>Depart Cabin. Drive South towards Moncton.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">13:00</span><span><strong>Sackville Waterfowl Park:</strong> Dog-friendly boardwalks. <br><span class="text-indigo-600 font-bold text-xs">â­ Finn Spot:</span> Easy trails, lots of ducks!</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">15:00</span><span>Cross Confederation Bridge.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">17:00</span><span><strong>Camp Setup:</strong> Stanhope Campground. <br><span class="text-green-600 font-bold text-xs">ğŸ¦Š Nature:</span> Watch for Red Foxes near the dunes.</span></li>
              </ul>
              <div class="mt-5 flex flex-wrap gap-2">
                <button class="btn-map px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-focus="stanhope">ğŸ“ Focus stop</button>
                <button class="btn-copy px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-copy="Sun Aug 16 â€” Cabin â†’ Stanhope (PEI). Key stop: Sackville Waterfowl Park (dog-friendly boardwalks). Cross Confederation Bridge." >ğŸ“‹ Copy summary</button>
              </div>
            </div>
          </details>

          <!-- Day 3 -->
          <details class="day-card group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" data-day="3" data-tags="greenwich dunes piping plovers national park beach auntie charlottetown">
            <summary class="flex items-center p-4 bg-slate-50 cursor-pointer select-none">
              <div class="bg-amber-500 text-white font-bold w-12 h-12 rounded-lg flex items-center justify-center text-xl shadow-md z-10">3</div>
              <div class="ml-4 flex-grow">
                <h3 class="font-bold text-slate-800 text-lg">Mon, Aug 17: Plovers & Auntie</h3>
                <p class="text-sm text-slate-500">Stanhope Area (Local driving)</p>
              </div>
              <div class="text-slate-400 transform group-open:rotate-180 transition-transform">â–¼</div>
            </summary>
            <div class="p-6 border-t border-slate-100">
              <ul class="space-y-4 text-sm text-slate-700">
                <li class="flex"><span class="font-bold w-20 text-slate-400">08:00</span><span><strong>Greenwich Dunes:</strong> Floating boardwalks. <br><span class="text-green-600 font-bold text-xs">ğŸ¦ Birding:</span> Piping Plovers (Endangered) nesting on beaches.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">12:00</span><span>Visit Udit's Aunt.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">15:00</span><span><strong>Maddie's Pick #1:</strong> Check shared map pin. (Likely a local beach or cafe).</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">18:00</span><span>Sunset beach walk with Finn (leash required in National Park).</span></li>
              </ul>
              <div class="mt-5 flex flex-wrap gap-2">
                <button class="btn-map px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-focus="stanhope">ğŸ“ Focus area</button>
                <button class="btn-copy px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-copy="Mon Aug 17 â€” Greenwich Dunes (Piping Plovers), visit Aunt, Maddie's Pick #1, sunset beach walk (leash rules)." >ğŸ“‹ Copy summary</button>
              </div>
            </div>
          </details>

          <!-- Day 4 -->
          <details class="day-card group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" data-day="4" data-tags="point prim lighthouse grey seals charlottetown victoria park victoria row">
            <summary class="flex items-center p-4 bg-slate-50 cursor-pointer select-none">
              <div class="bg-green-600 text-white font-bold w-12 h-12 rounded-lg flex items-center justify-center text-xl shadow-md z-10">4</div>
              <div class="ml-4 flex-grow">
                <h3 class="font-bold text-slate-800 text-lg">Tue, Aug 18: Seals & City</h3>
                <p class="text-sm text-slate-500">Move to Charlottetown B&B</p>
              </div>
              <div class="text-slate-400 transform group-open:rotate-180 transition-transform">â–¼</div>
            </summary>
            <div class="p-6 border-t border-slate-100">
              <ul class="space-y-4 text-sm text-slate-700">
                <li class="flex"><span class="font-bold w-20 text-slate-400">10:00</span><span>Pack up camp. Drive East.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">11:30</span><span><strong>Point Prim Lighthouse:</strong> <br><span class="text-green-600 font-bold text-xs">ğŸ¦­ Wildlife:</span> Grey seals haul out at low tide.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">15:00</span><span>Check into Charlottetown B&B. Shower!</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">18:00</span><span><strong>Victoria Park:</strong> Boardwalks. Dinner on Victoria Row.</span></li>
              </ul>
              <div class="mt-5 flex flex-wrap gap-2">
                <button class="btn-map px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-focus="charlottetown">ğŸ“ Focus stop</button>
                <button class="btn-copy px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-copy="Tue Aug 18 â€” Move to Charlottetown. Stop at Point Prim Lighthouse for grey seals (low tide). Evening: Victoria Park + Victoria Row." >ğŸ“‹ Copy summary</button>
              </div>
            </div>
          </details>

          <!-- Day 5 -->
          <details class="day-card group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" data-day="5" data-tags="buffaloland bison cape tryon lighthouse cliffs french river hidden gem">
            <summary class="flex items-center p-4 bg-slate-50 cursor-pointer select-none">
              <div class="bg-green-600 text-white font-bold w-12 h-12 rounded-lg flex items-center justify-center text-xl shadow-md z-10">5</div>
              <div class="ml-4 flex-grow">
                <h3 class="font-bold text-slate-800 text-lg">Wed, Aug 19: Bison & Cliffs</h3>
                <p class="text-sm text-slate-500">Eastern PEI Day Trip</p>
              </div>
              <div class="text-slate-400 transform group-open:rotate-180 transition-transform">â–¼</div>
            </summary>
            <div class="p-6 border-t border-slate-100">
              <ul class="space-y-4 text-sm text-slate-700">
                <li class="flex"><span class="font-bold w-20 text-slate-400">10:00</span><span><strong>Buffaloland Provincial Park:</strong> <br><span class="text-indigo-600 font-bold text-xs">â­ Finn Spot:</span> Bison herd â€” unique photo op.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">13:00</span><span><strong>Cape Tryon Lighthouse:</strong> Hidden gem. Massive red cliffs, fewer tourists.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">16:00</span><span><strong>Maddie's Pick #2:</strong> Check shared map pin.</span></li>
              </ul>
              <div class="mt-5 flex flex-wrap gap-2">
                <button class="btn-map px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-focus="charlottetown">ğŸ“ Focus area</button>
                <button class="btn-copy px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-copy="Wed Aug 19 â€” Eastern PEI. Buffaloland bison, Cape Tryon cliffs, Maddie's Pick #2." >ğŸ“‹ Copy summary</button>
              </div>
            </div>
          </details>

          <!-- Day 6 -->
          <details class="day-card group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" data-day="6" data-tags="hopewell rocks fundy alma peregrine falcons dickson falls moose">
            <summary class="flex items-center p-4 bg-slate-50 cursor-pointer select-none">
              <div class="bg-teal-600 text-white font-bold w-12 h-12 rounded-lg flex items-center justify-center text-xl shadow-md z-10">6</div>
              <div class="ml-4 flex-grow">
                <h3 class="font-bold text-slate-800 text-lg">Thu, Aug 20: Tides & Falcons</h3>
                <p class="text-sm text-slate-500">PEI â†’ Alma, NB (Fundy)</p>
              </div>
              <div class="text-slate-400 transform group-open:rotate-180 transition-transform">â–¼</div>
            </summary>
            <div class="p-6 border-t border-slate-100">
              <ul class="space-y-4 text-sm text-slate-700">
                <li class="flex"><span class="font-bold w-20 text-slate-400">09:00</span><span>Depart PEI via Bridge.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">12:00</span><span><strong>Hopewell Rocks:</strong> Walk ocean floor. <br><span class="text-green-600 font-bold text-xs">ğŸ¦… Birding:</span> Peregrine falcons nest on cliffs.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">16:00</span><span>Drive to Alma. Stay at motel/cottage.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">17:00</span><span><strong>Fundy Park:</strong> Hike Dickson Falls. Watch for moose at dusk.</span></li>
              </ul>
              <div class="mt-5 flex flex-wrap gap-2">
                <button class="btn-map px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-focus="alma">ğŸ“ Focus stop</button>
                <button class="btn-copy px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-copy="Thu Aug 20 â€” PEI â†’ Alma (Fundy). Hopewell Rocks (tides + peregrines), Fundy Park/Dickson Falls." >ğŸ“‹ Copy summary</button>
              </div>
            </div>
          </details>

          <!-- Day 7 -->
          <details class="day-card group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" data-day="7" data-tags="riviere-du-loup parc de la pointe sunset st lawrence hotel dog">
            <summary class="flex items-center p-4 bg-slate-50 cursor-pointer select-none">
              <div class="bg-blue-600 text-white font-bold w-12 h-12 rounded-lg flex items-center justify-center text-xl shadow-md z-10">7</div>
              <div class="ml-4 flex-grow">
                <h3 class="font-bold text-slate-800 text-lg">Fri, Aug 21: French Sunset</h3>
                <p class="text-sm text-slate-500">Alma â†’ RiviÃ¨re-du-Loup (4.5h Drive)</p>
              </div>
              <div class="text-slate-400 transform group-open:rotate-180 transition-transform">â–¼</div>
            </summary>
            <div class="p-6 border-t border-slate-100">
              <ul class="space-y-4 text-sm text-slate-700">
                <li class="flex"><span class="font-bold w-20 text-slate-400">09:00</span><span>Scenic drive through New Brunswick woods.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">14:00</span><span>Arrive RiviÃ¨re-du-Loup. Check into pet-friendly hotel.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">16:00</span><span><strong>Parc de la Pointe:</strong> Long walk with Finn.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">19:00</span><span>Sunset dinner by the St. Lawrence River.</span></li>
              </ul>
              <div class="mt-5 flex flex-wrap gap-2">
                <button class="btn-map px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-focus="rdl">ğŸ“ Focus stop</button>
                <button class="btn-copy px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-copy="Fri Aug 21 â€” Alma â†’ RiviÃ¨re-du-Loup. Check-in, Parc de la Pointe sunset walk with Finn, dinner by St. Lawrence." >ğŸ“‹ Copy summary</button>
              </div>
            </div>
          </details>

          <!-- Day 8 -->
          <details class="day-card group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" data-day="8" data-tags="whale watching aml beluga minke ottawa drive home">
            <summary class="flex items-center p-4 bg-slate-50 cursor-pointer select-none">
              <div class="bg-slate-700 text-white font-bold w-12 h-12 rounded-lg flex items-center justify-center text-xl shadow-md z-10">8</div>
              <div class="ml-4 flex-grow">
                <h3 class="font-bold text-slate-800 text-lg">Sat, Aug 22: Whales & Home</h3>
                <p class="text-sm text-slate-500">RiviÃ¨re-du-Loup â†’ Ottawa (6h Drive)</p>
              </div>
              <div class="text-slate-400 transform group-open:rotate-180 transition-transform">â–¼</div>
            </summary>
            <div class="p-6 border-t border-slate-100">
              <ul class="space-y-4 text-sm text-slate-700">
                <li class="flex"><span class="font-bold w-20 text-slate-400">09:30</span><span><strong>Whale Watching:</strong> 3.5h AML Cruise. <br><span class="text-green-600 font-bold text-xs">ğŸ‹ Wildlife:</span> Belugas and minke whales. Finn stays in hotel.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">13:00</span><span>Lunch & walk Finn.</span></li>
                <li class="flex"><span class="font-bold w-20 text-slate-400">14:00</span><span>Drive home. Arrive Ottawa ~8pm.</span></li>
              </ul>
              <div class="mt-5 flex flex-wrap gap-2">
                <button class="btn-map px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-focus="ottawa">ğŸ“ Focus home</button>
                <button class="btn-copy px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-copy="Sat Aug 22 â€” Whale watching (AML), lunch + Finn walk, drive back to Ottawa." >ğŸ“‹ Copy summary</button>
              </div>
            </div>
          </details>

        </div>
      </section>

      <!-- TAB: BUDGET -->
      <section id="content-budget" class="hidden space-y-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

          <!-- Controls -->
          <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Cost Estimator</h2>

            <div class="space-y-6">
              <div class="space-y-2">
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 flex justify-between items-center">
                  <span class="text-xs font-bold text-green-800 uppercase">Night 1 (Cabin)</span>
                  <span class="text-sm font-bold text-green-700">$116</span>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 flex justify-between items-center">
                  <span class="text-xs font-bold text-green-800 uppercase">Camping (2 Nts)</span>
                  <span class="text-sm font-bold text-green-700">~$100</span>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex justify-between items-center">
                  <span class="text-xs font-bold text-blue-800 uppercase">Whale Cruise (2 Tix)</span>
                  <span class="text-sm font-bold text-blue-700">~$200</span>
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2 flex justify-between">
                  <span>Remaining 4 Nights (B&Bs)</span>
                  <span class="text-pink-600 font-bold">$<span id="val-accom">180</span></span>
                </label>
                <input type="range" id="input-accom" min="120" max="400" step="10" value="180" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-pink-600" />
                <p class="text-xs text-slate-400 mt-1">Charlottetown, Alma, Riv-du-Loup</p>
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2 flex justify-between">
                  <span>Food / Person / Day</span>
                  <span class="text-pink-600 font-bold">$<span id="val-food">75</span></span>
                </label>
                <input type="range" id="input-food" min="40" max="200" step="5" value="75" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-pink-600" />
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2 flex justify-between">
                  <span>Gas Price</span>
                  <span class="text-pink-600 font-bold">$<span id="val-gas">1.65</span></span>
                </label>
                <input type="range" id="input-gas" min="1.30" max="2.20" step="0.05" value="1.65" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-pink-600" />
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2 flex justify-between">
                  <span>Vehicle Fuel (L/100km)</span>
                  <span class="text-pink-600 font-bold"><span id="val-fuel">9.5</span></span>
                </label>
                <input type="range" id="input-fuel" min="7" max="14" step="0.1" value="9.5" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-pink-600" />
                <p class="text-xs text-slate-400 mt-1">Tune if you swap cars or load changes.</p>
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2 flex justify-between">
                  <span>Trip km (estimate)</span>
                  <span class="text-pink-600 font-bold"><span id="val-km">2850</span> km</span>
                </label>
                <input type="range" id="input-km" min="2000" max="4000" step="50" value="2850" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-pink-600" />
              </div>
            </div>

            <div class="mt-8 pt-6 border-t border-slate-100">
              <div class="flex justify-between items-end mb-2">
                <span class="text-slate-600 font-medium">Total Cost</span>
                <span id="total-cost" class="text-3xl font-bold text-slate-800">$0</span>
              </div>
              <div class="flex justify-between items-end bg-pink-50 p-3 rounded-lg">
                <span class="text-pink-800 text-sm font-medium">Per Person</span>
                <span id="per-person-cost" class="text-xl font-bold text-pink-700">$0</span>
              </div>
              <div class="mt-3 text-xs text-slate-400">Includes bridge + whale cruise. â€œFunâ€ is padded with a small misc buffer.</div>
            </div>
          </div>

          <!-- Visualization -->
          <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center">
            <div class="relative w-full max-w-[520px] mx-auto h-[360px]">
              <canvas id="budgetChart"></canvas>
            </div>
          </div>

        </div>
      </section>

      <!-- TAB: ATTRACTIONS -->
      <section id="content-attractions" class="hidden space-y-8">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
          <div>
            <h2 class="text-2xl font-bold text-slate-800">Wildlife & Nature Targets</h2>
            <p class="text-slate-600" id="attraction-subtitle">Your target species for this trip.</p>
          </div>
          <div class="flex space-x-2 mt-4 md:mt-0 flex-wrap gap-2">
            <button onclick="renderAttractions('all')" class="px-4 py-2 text-sm bg-slate-800 text-white rounded-full">All</button>
            <button onclick="renderAttractions('mammals')" class="px-4 py-2 text-sm bg-white border border-blue-200 text-blue-700 rounded-full font-bold">Whales & Mammals</button>
            <button onclick="renderAttractions('birds')" class="px-4 py-2 text-sm bg-white border border-amber-200 text-amber-700 rounded-full font-bold">Birding</button>
            <button onclick="renderAttractions('scenic')" class="px-4 py-2 text-sm bg-white border border-green-200 text-green-700 rounded-full font-bold">Landscapes</button>
          </div>
        </div>

        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-100">
          <div class="flex flex-col md:flex-row gap-3 md:items-center">
            <div class="flex-1">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Search wildlife spots</label>
              <input id="attraction-search" type="text" placeholder="Try: plover, seal, cliffsâ€¦" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none transition" />
            </div>
            <div class="md:w-64">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Sort</label>
              <select id="attraction-sort" class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-pink-500 outline-none transition">
                <option value="title">Title (Aâ€“Z)</option>
                <option value="cat">Category</option>
                <option value="loc">Location</option>
              </select>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="attraction-grid"></div>
      </section>

      <!-- TAB: LOGISTICS -->
      <section id="content-logistics" class="hidden space-y-8">

        <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-xl shadow-sm mb-8 animate-pulse-red">
          <div class="flex items-start">
            <div class="text-3xl mr-4">â°</div>
            <div>
              <h3 class="text-xl font-bold text-red-700">CRITICAL: Stanhope Booking</h3>
              <p class="text-sm text-red-900 mt-1 font-semibold">Parks Canada Reservations Open: <span class="underline">Feb 9 @ 7:00 AM ET</span>.</p>
              <p class="text-xs text-red-800 mt-2">Target: Stanhope Campground (North Shore). Create account beforehand.</p>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="btn-add-reminder" class="px-3 py-2 rounded-lg bg-red-600 text-white font-bold hover:bg-red-700">ğŸ—“ï¸ Download reminder .ics</button>
                <button class="btn-copy px-3 py-2 rounded-lg border border-red-200 bg-white hover:bg-red-50 text-sm font-semibold" data-copy="Reminder: Parks Canada reservations open Feb 9 @ 7:00 AM ET for Stanhope Campground." >ğŸ“‹ Copy reminder</button>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-green-100 mb-8 overflow-hidden">
          <div class="bg-green-700 p-4 text-white flex justify-between items-center">
            <h3 class="text-lg font-bold flex items-center"><span class="text-2xl mr-2">âœ…</span> Night 1: Trapper's Cabin</h3>
            <span class="bg-white/20 text-xs px-2 py-1 rounded uppercase font-bold">Booked</span>
          </div>
          <div class="p-6">
            <div class="flex items-center text-sm text-slate-700 mb-2"><span class="font-bold mr-2">Vehicle:</span> Kia Sportage (High clearance for access).</div>
            <div class="flex items-center text-sm text-slate-700"><span class="font-bold mr-2">Prep:</span> Shop in Grand Falls.</div>
          </div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-2xl shadow-sm mb-8 overflow-hidden">
          <div class="p-6">
            <div class="flex items-center mb-4"><span class="text-3xl mr-3">ğŸ¶</span><h3 class="text-xl font-bold text-blue-900">Finn's Logistics (RiviÃ¨re-du-Loup)</h3></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-white p-4 rounded-lg shadow-sm">
                <h4 class="font-bold text-slate-800 mb-2">Friday Evening</h4>
                <ul class="text-sm text-slate-600 space-y-1 list-disc pl-4">
                  <li><strong>Walk:</strong> <span class="text-blue-600 underline">Parc de la Pointe</span> is perfect for sunset dog walking.</li>
                  <li><strong>Stay:</strong> Ensure hotel allows dogs to be left alone (crate usually required).</li>
                </ul>
              </div>
              <div class="bg-white p-4 rounded-lg shadow-sm">
                <h4 class="font-bold text-slate-800 mb-2">Saturday Morning</h4>
                <ul class="text-sm text-slate-600 space-y-1 list-disc pl-4">
                  <li><strong>Whale Tour:</strong> 9:30 AM â€“ 1:00 PM.</li>
                  <li><strong>Action:</strong> Walk Finn hard before 9am. Leave him settled in crate.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Simple checklist -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-slate-800">Quick Checklist</h3>
            <button id="btn-reset-checklist" class="text-sm font-semibold text-slate-600 hover:text-slate-900">Reset</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="checklist"></div>
          <p class="text-xs text-slate-400 mt-3">Checklist progress is saved in your browser (localStorage).</p>
        </div>

      </section>
    </main>

    <footer class="bg-slate-800 text-slate-400 p-8 text-center text-sm">
      <p>&copy; 2026 Maritime Trip Planner.</p>
      <p class="text-xs text-slate-500 mt-2">Built as a single-file GitHub Pages site. Password overlay is a UX lock only.</p>
    </footer>
  </div>

  <script>
    // =====================
    // Configuration
    // =====================

    // Note: If you host on GitHub Pages, anyone can view source and see this.
    // If you want real privacy, keep this repo private and use a different hosting approach.
    const APP_PASSWORD = 'maritime';

    // Trip date text (display only)
    const TRIP_DATES_LABEL = 'Aug 15â€“22';

    // Trip values used for stats + budget
    const DEFAULTS = {
      km: 2850,
      fuelLPer100: 9.5,
      bridge: 50.25,
      trapper: 116,
      camping: 100,
      whales: 200,
      miscFunBuffer: 150,
      variableNights: 4,
      tripDays: 8,
      people: 2
    };

    // Checklist items
    const CHECKLIST_ITEMS = [
      { id: 'pc-account', label: 'Create Parks Canada account (Stanhope booking)' },
      { id: 'dog-crate', label: 'Crate setup confirmed for hotel (Finn)' },
      { id: 'snacks', label: 'Road snacks + water stocked' },
      { id: 'binoculars', label: 'Binoculars / camera batteries charged' },
      { id: 'tide-check', label: 'Check Hopewell Rocks tide window' },
      { id: 'hotel-dog', label: 'Confirm dog policy: left alone / fees' },
      { id: 'grocery', label: 'Grand Falls grocery list ready' },
      { id: 'ics', label: 'Calendar imported / events reviewed' }
    ];

    // =====================
    // Assets + data
    // =====================

    const assets = {
      aunt: 'https://images.unsplash.com/photo-1542318859-99c08d984143?q=80&w=800&auto=format&fit=crop',
      anne: 'https://images.unsplash.com/photo-1599946347371-68eb71b16afc?q=80&w=800&auto=format&fit=crop',
      brackley: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=800&auto=format&fit=crop',
      basin: 'https://images.unsplash.com/photo-1476673160081-cf060971a4ae?q=80&w=800&auto=format&fit=crop',
      hopewell: 'https://images.unsplash.com/photo-1483729558449-99ef09a8c325?q=80&w=800&auto=format&fit=crop',
      fundy: 'https://images.unsplash.com/photo-1443632864897-14973fa006cf?q=80&w=800&auto=format&fit=crop',
      charlottetown: 'https://images.unsplash.com/photo-1555685812-4b943f3e99a0?q=80&w=800&auto=format&fit=crop',
      beluga: 'https://images.unsplash.com/photo-1568430462989-44163eb1752f?q=80&w=800&auto=format&fit=crop',
      fox: 'https://images.unsplash.com/photo-1474511320723-9a56873867b5?q=80&w=800&auto=format&fit=crop',
      plover: 'https://images.unsplash.com/photo-1552353617-3913788a1834?q=80&w=800&auto=format&fit=crop',
      seal: 'https://images.unsplash.com/photo-1563200767-17b070921869?q=80&w=800&auto=format&fit=crop',
      falcon: 'https://images.unsplash.com/photo-1619623696803-b097b667232c?q=80&w=800&auto=format&fit=crop',
      bison: 'https://images.unsplash.com/photo-1505238240580-c0812e12822a?q=80&w=800&auto=format&fit=crop',
      waterfowl: 'https://images.unsplash.com/photo-1480044965905-02098d419e96?q=80&w=800&auto=format&fit=crop',
      capetryon: 'https://images.unsplash.com/photo-1621882414734-7221e106950e?q=80&w=800&auto=format&fit=crop'
    };

    const attractions = [
      { title: 'Beluga Whales', cat: 'mammals', loc: 'RiviÃ¨re-du-Loup (QC)', img: assets.beluga, desc: 'Saturday AM boat tour. White whales in the St. Lawrence!' },
      { title: 'Red Foxes', cat: 'mammals', loc: 'Stanhope (PEI)', img: assets.fox, desc: "PEI's famous red foxes roam the campground dunes." },
      { title: 'Sackville Waterfowl', cat: 'birds', loc: 'Sackville (NB)', img: assets.waterfowl, desc: 'World-class boardwalks through marshes. 100% dog-friendly!' },
      { title: 'Bison Herd', cat: 'mammals', loc: 'Buffaloland (PEI)', img: assets.bison, desc: 'A provincial park herd near Montague. Easy viewing.' },
      { title: 'Piping Plovers', cat: 'birds', loc: 'Greenwich Dunes (PEI)', img: assets.plover, desc: 'Endangered shorebirds nesting on the beaches.' },
      { title: 'Peregrine Falcons', cat: 'birds', loc: 'Hopewell Rocks (NB)', img: assets.falcon, desc: 'They nest on the flowerpot rock cliffs. Fastest bird in the world.' },
      { title: 'Grey Seals', cat: 'mammals', loc: 'Point Prim (PEI)', img: assets.seal, desc: 'Hauled out on the rocks at low tide near the lighthouse.' },
      { title: 'Cape Tryon Cliffs', cat: 'scenic', loc: 'French River (PEI)', img: assets.capetryon, desc: 'Highest cliffs on PEI. Spectacular views, less crowded.' },
      { title: "Maddie's Pick #1", cat: 'scenic', loc: 'PEI', img: assets.anne, desc: 'Custom user stop.' },
      { title: "Maddie's Pick #2", cat: 'scenic', loc: 'NB', img: assets.fundy, desc: 'Custom user stop.' }
    ];

    // =====================
    // Map logic
    // =====================

    let mapInstance = null;
    let mapMarkers = [];
    let mapLines = [];
    let markersVisible = true;
    let linesVisible = true;

    const locs = {
      ottawa: [45.4215, -75.6972],
      trapper: [46.7, -67.6],
      stanhope: [46.4, -63.1],
      charlottetown: [46.2, -63.1],
      alma: [45.6, -64.9],
      rdl: [47.8, -69.5],
      bridge: [46.2, -63.7]
    };

    function initLeafletMap() {
      if (mapInstance) return;

      mapInstance = L.map('map', { scrollWheelZoom: false }).setView([46.8, -66], 6);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(mapInstance);

      // Lines
      const line1 = L.polyline([locs.ottawa, [46.8, -71.2], locs.trapper], { color: '#db2777', weight: 5 });
      const line2 = L.polyline([locs.trapper, locs.bridge, locs.stanhope], { color: '#db2777', weight: 5 });
      const line3 = L.polyline([locs.charlottetown, locs.bridge, locs.alma], { color: '#059669', weight: 5 });
      const line4 = L.polyline([locs.alma, locs.rdl], { color: '#059669', weight: 5 });
      const line5 = L.polyline([locs.rdl, locs.ottawa], { color: '#64748b', weight: 3, dashArray: '5, 10' });
      mapLines = [line1, line2, line3, line4, line5];
      mapLines.forEach(l => l.addTo(mapInstance));

      // Markers
      mapMarkers = [
        L.marker(locs.ottawa).bindPopup('Ottawa'),
        L.marker(locs.trapper).bindPopup("Trapper's Cabin (Night 1)"),
        L.marker(locs.stanhope).bindPopup('Stanhope Camp (Nights 2-3)'),
        L.marker(locs.charlottetown).bindPopup('Charlottetown (Nights 4-5)'),
        L.marker(locs.alma).bindPopup('Fundy/Alma (Night 6)'),
        L.marker(locs.rdl).bindPopup('RiviÃ¨re-du-Loup (Night 7)')
      ];
      mapMarkers.forEach(m => m.addTo(mapInstance));

      // Fit route on first render
      setTimeout(() => fitRoute(), 150);
    }

    function fitRoute() {
      if (!mapInstance || mapLines.length === 0) return;
      const group = L.featureGroup([...mapLines, ...mapMarkers]);
      mapInstance.fitBounds(group.getBounds().pad(0.15));
    }

    function toggleMarkers() {
      if (!mapInstance) return;
      markersVisible = !markersVisible;
      mapMarkers.forEach(m => {
        if (markersVisible) m.addTo(mapInstance);
        else mapInstance.removeLayer(m);
      });
      toast(markersVisible ? 'ğŸ“ Markers on' : 'ğŸ“ Markers off');
    }

    function toggleLines() {
      if (!mapInstance) return;
      linesVisible = !linesVisible;
      mapLines.forEach(l => {
        if (linesVisible) l.addTo(mapInstance);
        else mapInstance.removeLayer(l);
      });
      toast(linesVisible ? 'ã€°ï¸ Route lines on' : 'ã€°ï¸ Route lines off');
    }

    function focusStop(key) {
      if (!mapInstance || !locs[key]) return;
      mapInstance.setView(locs[key], key === 'ottawa' ? 8 : 9, { animate: true });
      toast('ğŸ“ Centered on stop');
    }

    // =====================
    // Budget logic
    // =====================

    let budgetChartInstance = null;

    function updateBudget() {
      const accom = parseFloat(document.getElementById('input-accom')?.value || '0');
      const food = parseFloat(document.getElementById('input-food')?.value || '0');
      const gasPrice = parseFloat(document.getElementById('input-gas')?.value || '0');
      const fuel = parseFloat(document.getElementById('input-fuel')?.value || DEFAULTS.fuelLPer100);
      const km = parseFloat(document.getElementById('input-km')?.value || DEFAULTS.km);

      // UI labels
      document.getElementById('val-accom').innerText = accom.toFixed(0);
      document.getElementById('val-food').innerText = food.toFixed(0);
      document.getElementById('val-gas').innerText = gasPrice.toFixed(2);
      document.getElementById('val-fuel').innerText = fuel.toFixed(1);
      document.getElementById('val-km').innerText = km.toFixed(0);

      // Fixed
      const fixedAccom = DEFAULTS.trapper + DEFAULTS.camping;

      // Variable
      const gas = Math.round((km / 100) * fuel * gasPrice);
      const varAccom = DEFAULTS.variableNights * accom;
      const foodTotal = food * DEFAULTS.people * DEFAULTS.tripDays;
      const fun = DEFAULTS.bridge + DEFAULTS.whales + DEFAULTS.miscFunBuffer;

      const total = gas + fixedAccom + varAccom + foodTotal + fun;

      document.getElementById('total-cost').innerText = '$' + total.toLocaleString();
      document.getElementById('per-person-cost').innerText = '$' + Math.round(total / DEFAULTS.people).toLocaleString();

      if (budgetChartInstance) {
        budgetChartInstance.data.datasets[0].data = [gas, fixedAccom + varAccom, foodTotal, fun];
        budgetChartInstance.update();
      }

      // Stats
      document.getElementById('stat-distance').innerText = `~${Math.round(km).toLocaleString()} km`;
    }

    function initBudgetCalc() {
      const canvas = document.getElementById('budgetChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      budgetChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Transport', 'Stay', 'Food', 'Fun'],
          datasets: [{
            data: [1, 1, 1, 1],
            backgroundColor: ['#0891b2', '#f59e0b', '#10b981', '#6366f1']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%'
        }
      });

      ['accom', 'food', 'gas', 'fuel', 'km'].forEach(id => {
        const el = document.getElementById(`input-${id}`);
        if (el) el.addEventListener('input', updateBudget);
      });

      updateBudget();
    }

    // =====================
    // Attractions logic
    // =====================

    let attractionFilter = 'all';

    // Robust diacritic stripping:
    // - Uses Unicode property escapes when available
    // - Falls back to a BMP combining mark range if not supported
    function normalize(str) {
      const s = (str || '').toString().toLowerCase().normalize('NFD');
      try {
        // Most modern browsers
        return s.replace(/\p{Diacritic}/gu, '');
      } catch (_) {
        // Older engines
        return s.replace(/[\u0300-\u036f]/g, '');
      }
    }

    function getAttractionQuery() {
      return normalize(document.getElementById('attraction-search')?.value || '');
    }

    function getAttractionSort() {
      return document.getElementById('attraction-sort')?.value || 'title';
    }

    function renderAttractions(filter) {
      attractionFilter = filter;
      const grid = document.getElementById('attraction-grid');
      const query = getAttractionQuery();
      const sort = getAttractionSort();
      if (!grid) return;

      let list = [...attractions];

      // Filter
      if (filter !== 'all') list = list.filter(i => i.cat === filter);

      // Search
      if (query) {
        list = list.filter(i => normalize(`${i.title} ${i.cat} ${i.loc} ${i.desc}`).includes(query));
      }

      // Sort
      list.sort((a, b) => {
        const av = normalize(a[sort]);
        const bv = normalize(b[sort]);
        return av.localeCompare(bv);
      });

      grid.innerHTML = '';

      if (list.length === 0) {
        grid.innerHTML = `<div class="col-span-full bg-white border border-slate-100 rounded-2xl p-8 text-center text-slate-600">No matches. Try a different search.</div>`;
        return;
      }

      list.forEach(item => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden group hover:-translate-y-1 transition';

        let fallback = 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=800&auto=format&fit=crop';
        if (item.cat === 'mammals') fallback = assets.fox;

        card.innerHTML = `
          <div class="h-48 overflow-hidden relative">
            <img src="${item.img}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" onerror="this.src='${fallback}'" alt="${item.title}">
            <div class="absolute top-2 right-2 bg-white/90 text-xs font-bold px-2 py-1 rounded shadow uppercase">${item.cat}</div>
          </div>
          <div class="p-6">
            <h3 class="text-lg font-bold text-slate-800">${item.title}</h3>
            <p class="text-xs font-bold text-slate-400 uppercase mb-2">ğŸ“ ${item.loc}</p>
            <p class="text-sm text-slate-600">${item.desc}</p>
            <div class="mt-4 flex flex-wrap gap-2">
              <button class="btn-copy px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm font-semibold" data-copy="${item.title} â€” ${item.loc}. ${item.desc}">ğŸ“‹ Copy</button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // =====================
    // Itinerary helpers
    // =====================

    function expandAll(open) {
      document.querySelectorAll('details.day-card').forEach(d => { d.open = open; });
    }

    function filterItinerary() {
      const q = normalize(document.getElementById('itinerary-search')?.value || '');
      const cards = document.querySelectorAll('details.day-card');
      let visible = 0;
      cards.forEach(card => {
        const tags = normalize(card.getAttribute('data-tags') || '');
        const content = normalize(card.innerText || '');
        const match = !q || tags.includes(q) || content.includes(q);
        card.classList.toggle('hidden', !match);
        if (match) visible++;
      });
      toast(q ? `Showing ${visible} day(s)` : 'Itinerary reset');
    }

    // =====================
    // Password + lock
    // =====================

    function checkPassword() {
      const input = document.getElementById('password-input');
      const val = (input?.value || '').toLowerCase().trim();
      if (val === APP_PASSWORD) {
        unlock();
      } else {
        document.getElementById('error-msg')?.classList.remove('hidden');
      }
    }

    function unlock() {
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('app-container').classList.remove('hidden');
      localStorage.setItem('maritime_unlocked', '1');

      // Init features
      setTimeout(() => {
        initLeafletMap();
        initBudgetCalc();
        renderAttractions('all');
        initChecklist();
        lucide.createIcons();
      }, 120);

      // Update labels
      const dates = document.getElementById('trip-dates');
      if (dates) dates.innerText = TRIP_DATES_LABEL;

      toast('Unlocked');
    }

    function lock() {
      localStorage.removeItem('maritime_unlocked');
      document.getElementById('app-container').classList.add('hidden');
      document.getElementById('login-overlay').style.display = 'flex';
      toast('Locked');
    }

    // =====================
    // Tabs
    // =====================

    function switchTab(id) {
      ['route', 'budget', 'attractions', 'logistics'].forEach(t => {
        document.getElementById(`content-${t}`).classList.add('hidden');
        document.getElementById(`tab-${t}`).classList.remove('tab-active');
        document.getElementById(`tab-${t}`).classList.add('tab-inactive');
      });

      document.getElementById(`content-${id}`).classList.remove('hidden');
      document.getElementById(`tab-${id}`).classList.add('tab-active');

      if (id === 'route' && mapInstance) setTimeout(() => mapInstance.invalidateSize(), 120);
      if (id === 'budget') setTimeout(() => updateBudget(), 80);
    }

    // =====================
    // Toast + clipboard
    // =====================

    let toastTimer = null;
    function toast(msg, icon = 'âœ…') {
      const el = document.getElementById('toast');
      const t = document.getElementById('toast-text');
      const i = document.getElementById('toast-icon');
      if (!el || !t || !i) return;

      i.textContent = icon;
      t.textContent = msg;
      el.classList.remove('hidden');

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.add('hidden'), 2200);
    }

    async function copyText(text) {
      try {
        await navigator.clipboard.writeText(text);
        toast('Copied to clipboard');
      } catch (e) {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('Copied (fallback)');
      }
    }

    // =====================
    // ICS generation
    // =====================

    function formatICSDateUTC(date) {
      // YYYYMMDDTHHMMSSZ
      const pad = (n) => String(n).padStart(2, '0');
      return (
        date.getUTCFullYear() +
        pad(date.getUTCMonth() + 1) +
        pad(date.getUTCDate()) +
        'T' +
        pad(date.getUTCHours()) +
        pad(date.getUTCMinutes()) +
        '00Z'
      );
    }

    function downloadText(filename, text) {
      const blob = new Blob([text], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function buildTripICS() {
      // These are sample timestamps. Adjust to your real year/time if needed.
      const now = new Date();
      const uidBase = 'maritime-trip-' + now.getTime();

      const events = [
        { summary: "Day 1 â€” Ottawa â†’ Trapper's Cabin", start: '20260815T070000', end: '20260815T200000', desc: 'Drive day. Stops: RiviÃ¨re-du-Loup (Parc de la Pointe), Grand Falls groceries.' },
        { summary: 'Day 2 â€” Trapper\'s â†’ Stanhope (PEI)', start: '20260816T090000', end: '20260816T190000', desc: 'Sackville Waterfowl Park. Cross Confederation Bridge. Camp in Stanhope.' },
        { summary: 'Day 3 â€” Greenwich Dunes + family', start: '20260817T080000', end: '20260817T200000', desc: 'Greenwich boardwalks + Piping Plovers. Visit Aunt. Sunset walk.' },
        { summary: 'Day 4 â€” Point Prim seals + Charlottetown', start: '20260818T100000', end: '20260818T200000', desc: 'Pack up camp. Point Prim Lighthouse. Check in Charlottetown.' },
        { summary: 'Day 5 â€” Bison + Cape Tryon', start: '20260819T100000', end: '20260819T190000', desc: "Buffaloland bison, Cape Tryon cliffs, Maddie\'s Pick." },
        { summary: 'Day 6 â€” Hopewell Rocks + Fundy (Alma)', start: '20260820T090000', end: '20260820T200000', desc: 'Hopewell Rocks (tide dependent), drive to Alma, Fundy Park.' },
        { summary: 'Day 7 â€” Alma â†’ RiviÃ¨re-du-Loup', start: '20260821T090000', end: '20260821T200000', desc: 'Drive, check-in, Parc de la Pointe walk, sunset dinner.' },
        { summary: 'Day 8 â€” Whale watching + home', start: '20260822T093000', end: '20260822T200000', desc: 'Whale tour (AML), lunch + Finn walk, drive to Ottawa.' }
      ];

      let ics = '';
      ics += 'BEGIN:VCALENDAR\n';
      ics += 'VERSION:2.0\n';
      ics += 'PRODID:-//Maritime Explorer//EN\n';
      ics += 'CALSCALE:GREGORIAN\n';

      events.forEach((e, idx) => {
        ics += 'BEGIN:VEVENT\n';
        ics += `UID:${uidBase}-${idx}@maritime\n`;
        ics += `DTSTAMP:${formatICSDateUTC(new Date())}\n`;
        ics += `DTSTART:${e.start}\n`;
        ics += `DTEND:${e.end}\n`;
        ics += `SUMMARY:${e.summary.replace(/\n/g, ' ')}\n`;
        ics += `DESCRIPTION:${e.desc.replace(/\n/g, ' ')}\n`;
        ics += 'END:VEVENT\n';
      });

      ics += 'END:VCALENDAR\n';
      return ics;
    }

    function buildReminderICS() {
      const now = new Date();
      const uid = 'stanhope-reminder-' + now.getTime();
      // Feb 9, 2026 07:00 ET as floating time
      const start = '20260209T070000';
      const end = '20260209T073000';

      let ics = '';
      ics += 'BEGIN:VCALENDAR\n';
      ics += 'VERSION:2.0\n';
      ics += 'PRODID:-//Maritime Explorer//EN\n';
      ics += 'CALSCALE:GREGORIAN\n';
      ics += 'BEGIN:VEVENT\n';
      ics += `UID:${uid}@maritime\n`;
      ics += `DTSTAMP:${formatICSDateUTC(new Date())}\n`;
      ics += `DTSTART:${start}\n`;
      ics += `DTEND:${end}\n`;
      ics += 'SUMMARY:Parks Canada booking opens â€” Stanhope\n';
      ics += 'DESCRIPTION:Reservations open at 7:00 AM ET. Be logged in, payment ready.\n';
      ics += 'END:VEVENT\n';
      ics += 'END:VCALENDAR\n';
      return ics;
    }

    // =====================
    // Checklist
    // =====================

    function initChecklist() {
      const host = document.getElementById('checklist');
      if (!host) return;

      const saved = JSON.parse(localStorage.getItem('maritime_checklist') || '{}');

      host.innerHTML = '';
      CHECKLIST_ITEMS.forEach(item => {
        const checked = !!saved[item.id];
        const card = document.createElement('label');
        card.className = 'flex items-start gap-3 bg-slate-50 border border-slate-200 rounded-xl p-4 cursor-pointer hover:bg-slate-100 transition';
        card.innerHTML = `
          <input type="checkbox" class="mt-1 h-5 w-5 accent-pink-600" ${checked ? 'checked' : ''} data-check="${item.id}" />
          <div>
            <div class="font-semibold text-slate-800">${item.label}</div>
            <div class="text-xs text-slate-500">Tap to toggle</div>
          </div>
        `;
        host.appendChild(card);
      });

      host.addEventListener('change', (e) => {
        const t = e.target;
        if (!(t instanceof HTMLInputElement)) return;
        const key = t.getAttribute('data-check');
        if (!key) return;
        const next = JSON.parse(localStorage.getItem('maritime_checklist') || '{}');
        next[key] = t.checked;
        localStorage.setItem('maritime_checklist', JSON.stringify(next));
      });
    }

    function resetChecklist() {
      localStorage.removeItem('maritime_checklist');
      initChecklist();
      toast('Checklist reset');
    }

    // =====================
    // Event bindings
    // =====================

    function bindUI() {
      // Enter-to-unlock
      const pwd = document.getElementById('password-input');
      pwd?.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPassword(); });

      // Remember unlock
      if (localStorage.getItem('maritime_unlocked') === '1') {
        unlock();
      }

      // Map buttons
      document.getElementById('btn-fit')?.addEventListener('click', fitRoute);
      document.getElementById('btn-toggle-markers')?.addEventListener('click', toggleMarkers);
      document.getElementById('btn-toggle-lines')?.addEventListener('click', toggleLines);

      // Itinerary search
      document.getElementById('itinerary-search')?.addEventListener('input', filterItinerary);

      // Expand/collapse
      document.getElementById('btn-expand-all')?.addEventListener('click', () => expandAll(true));
      document.getElementById('btn-collapse-all')?.addEventListener('click', () => expandAll(false));

      // Delegated copy + map focus buttons
      document.body.addEventListener('click', (e) => {
        const el = e.target;
        if (!(el instanceof HTMLElement)) return;

        const copyBtn = el.closest('.btn-copy');
        if (copyBtn) {
          const text = copyBtn.getAttribute('data-copy') || '';
          copyText(text);
          return;
        }

        const mapBtn = el.closest('.btn-map');
        if (mapBtn) {
          const key = mapBtn.getAttribute('data-focus');
          if (key) focusStop(key);
          return;
        }
      });

      // Attractions search/sort
      document.getElementById('attraction-search')?.addEventListener('input', () => renderAttractions(attractionFilter));
      document.getElementById('attraction-sort')?.addEventListener('change', () => renderAttractions(attractionFilter));

      // Share/print/lock
      document.getElementById('btn-share')?.addEventListener('click', () => {
        copyText(window.location.href);
      });
      document.getElementById('btn-print')?.addEventListener('click', () => window.print());
      document.getElementById('btn-lock')?.addEventListener('click', lock);

      // ICS downloads
      document.getElementById('btn-download-ics')?.addEventListener('click', () => {
        const ics = buildTripICS();
        downloadText('maritime-trip.ics', ics);
        toast('Downloaded maritime-trip.ics', 'ğŸ—“ï¸');
      });
      document.getElementById('btn-add-reminder')?.addEventListener('click', () => {
        const ics = buildReminderICS();
        downloadText('stanhope-booking-reminder.ics', ics);
        toast('Downloaded reminder .ics', 'â°');
      });

      // Checklist reset
      document.getElementById('btn-reset-checklist')?.addEventListener('click', resetChecklist);
    }

    // =====================
    // Global exports (fixes: â€œcheckPassword is not definedâ€ in environments where inline handlers
    // don't see script-scope functions, or when the script previously failed to parse.)
    // =====================

    function exportGlobals() {
      window.checkPassword = checkPassword;
      window.switchTab = switchTab;
      window.renderAttractions = renderAttractions;
    }

    // =====================
    // Tiny self-tests (do not affect UI; helps catch issues early)
    // =====================

    function runSelfTests() {
      console.assert(typeof window.checkPassword === 'function', 'SelfTest failed: checkPassword missing on window');
      console.assert(typeof window.switchTab === 'function', 'SelfTest failed: switchTab missing on window');
      console.assert(typeof window.renderAttractions === 'function', 'SelfTest failed: renderAttractions missing on window');
    }

    // =====================
    // Boot
    // =====================

    document.addEventListener('DOMContentLoaded', () => {
      exportGlobals();
      bindUI();
      // Render attractions list early for quick tab switching after unlock
      renderAttractions('all');

      // Stats
      document.getElementById('trip-dates')?.innerText = TRIP_DATES_LABEL;
      document.getElementById('stat-distance')?.innerText = `~${DEFAULTS.km.toLocaleString()} km`;
      document.getElementById('stat-drive')?.innerText = '~31 h';
      document.getElementById('stat-nights')?.innerText = '7';

      runSelfTests();
    });
  </script>
</body>
</html>
